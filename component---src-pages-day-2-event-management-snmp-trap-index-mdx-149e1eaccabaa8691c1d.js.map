{"version":3,"sources":["webpack:///./src/pages/day2/EventManagement/SNMP_Trap/index.mdx"],"names":["_frontmatter","layoutProps","MDXLayout","DefaultLayout","MDXContent","components","props","mdxType","parentName","isMDXComponent"],"mappings":"yeAMO,IAAMA,EAAe,GACtBC,EAAc,CAClBD,gBAEIE,EAAYC,IACH,SAASC,EAAT,GAGZ,IAFDC,EAEC,EAFDA,WACGC,E,oIACF,mBACD,OAAO,YAACJ,EAAD,KAAeD,EAAiBK,EAAhC,CAAuCD,WAAYA,EAAYE,QAAQ,cAG5E,+CACA,qJAAoI,mBAAGC,WAAW,KAAQ,CACtJ,KAAQ,uDADwH,UAApI,iFAEqG,mBAAGA,WAAW,KAAQ,CACvH,KAAQ,sEADyF,oBAFrG,4BAKA,0SACqK,mBAAGA,WAAW,KAAQ,CACvL,KAAQ,8DADyJ,6CADrK,KAIA,iCAAgB,0BAAYA,WAAW,KAAvB,kCAAhB,0FAAqL,0BAAYA,WAAW,KAAvB,UAArL,mEAA2S,mBAAGA,WAAW,KAAQ,CAC7T,KAAQ,8DAD+R,WAA3S,sFAE2G,mBAAGA,WAAW,KAAQ,CAC7H,KAAQ,2DAD+F,QAF3G,KAKA,oCAAmB,0BAAYA,WAAW,KAAvB,YAAnB,QAAgF,0BAAYA,WAAW,KAAvB,aAAhF,6BACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,8CAEL,mHAAkG,0BAAYA,WAAW,KAAvB,aAAlG,KACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,uIAKL,6BAAY,0BAAYA,WAAW,KAAvB,QAAZ,eAA4E,0BAAYA,WAAW,KAAvB,kCAA5E,oHAA2Q,0BAAYA,WAAW,KAAvB,kCAA3Q,MACA,2GACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,kJAEL,sCAAqB,0BAAYA,WAAW,KAAvB,qBAArB,KACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,+YAmBL,0FAAyE,0BAAYA,WAAW,KAAvB,eAAzE,+BAAgK,0BAAYA,WAAW,KAAvB,kCAAhK,0EACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,qLAEL,0DAAyC,mBAAGA,WAAW,KAAQ,CAC3D,KAAQ,+GAD6B,8BAAzC,QAEgD,mBAAGA,WAAW,KAAQ,CAClE,KAAQ,mFADoC,cAFhD,8BAIsD,0BAAYA,WAAW,KAAvB,wBAJtD,0DAKA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,sDAEL,kCAAiB,0BAAYA,WAAW,KAAvB,aAAjB,WACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,mDAEL,gHAA+F,0BAAYA,WAAW,KAAvB,mBAA/F,2BACA,kCAAiB,0BAAYA,WAAW,KAAvB,mCACjB,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,6FAEL,oGAAmF,0BAAYA,WAAW,KAAvB,kCAAnF,yCAAuM,0BAAYA,WAAW,KAAvB,iBAAvM,KACA,wCAAuB,0BAAYA,WAAW,KAAvB,iBAAvB,wCACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,+mEASL,wEACA,uBAAK,sBAAMA,WAAW,OAAU,IAA3B,8zDAOTJ,EAAWK,gBAAiB","file":"component---src-pages-day-2-event-management-snmp-trap-index-mdx-149e1eaccabaa8691c1d.js","sourcesContent":["import * as React from 'react'\n  /* @jsx mdx */\nimport { mdx } from '@mdx-js/react';\n/* @jsx mdx */\n\nimport DefaultLayout from \"/home/travis/build/ibm-cloud-architecture/cloudpak8s/node_modules/gatsby-theme-carbon/src/templates/Default.js\";\nexport const _frontmatter = {};\nconst layoutProps = {\n  _frontmatter\n};\nconst MDXLayout = DefaultLayout;\nexport default function MDXContent({\n  components,\n  ...props\n}) {\n  return <MDXLayout {...layoutProps} {...props} components={components} mdxType=\"MDXLayout\">\n\n\n    <h2>{`Alert Manager to SNMP`}</h2>\n    <p>{`Prometheus Alertmanager natively supports a couple of different event destinations like Slack, email, PagerDuty, HipChat and `}<a parentName=\"p\" {...{\n        \"href\": \"https://prometheus.io/docs/alerting/configuration/\"\n      }}>{`others`}</a>{`. For notification mechanisms not natively supported by the Alertmanager, the `}<a parentName=\"p\" {...{\n        \"href\": \"https://prometheus.io/docs/alerting/configuration/#webhook_config\"\n      }}>{`webhook receiver`}</a>{` allows for integration.`}</p>\n    <p>{`SNMP traps are still a popular method of sending events informing about issues that needs to be reported.\nThe instructions below allows to quickly setup a simple integration mechanism which will allow to generate SNMP traps for selected Prometheus alerts using open source `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/chrusty/prometheus_webhook_snmptrapper\"\n      }}>{`Prometheus WebHook to SNMP-trap forwarder`}</a>{`.`}</p>\n    <p>{`1). Copy `}<inlineCode parentName=\"p\">{`prometheus_webhook_snmptrapper`}</inlineCode>{` to a Linux server accessible from your Prometheus AlertManager instance (lets name it `}<inlineCode parentName=\"p\">{`linux1`}</inlineCode>{`). It is a single binary file which can be compiled from Golang `}<a parentName=\"p\" {...{\n        \"href\": \"https://github.com/chrusty/prometheus_webhook_snmptrapper\"\n      }}>{`sources`}</a>{` available on GitHub. You can also download the compiled Linux 64-bit version from `}<a parentName=\"p\" {...{\n        \"href\": \"https://ibm.box.com/s/sn45d6n2mviwwi3iusmzpxa8fzd75l2p\"\n      }}>{`here`}</a>{`.`}</p>\n    <p>{`2). Install `}<inlineCode parentName=\"p\">{`net-snmp`}</inlineCode>{` and `}<inlineCode parentName=\"p\">{`snmptrapd`}</inlineCode>{` packages. On Ubuntu run:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`sudo apt-get install net-snmp snmptrapd\n`}</code></pre>\n    <p>{`3). In the AlertManager configuration file, define the webhook receiver address in section `}<inlineCode parentName=\"p\">{`receivers`}</inlineCode>{`:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`    receivers:\n      - name: prometheus_webhook_snmptrapper\n        webhook_configs:\n        - url: 'http://<linux1_ip>:9999'\n`}</code></pre>\n    <p>{`Port `}<inlineCode parentName=\"p\">{`9999`}</inlineCode>{` is port of `}<inlineCode parentName=\"p\">{`prometheus_webhook_snmptrapper`}</inlineCode>{` webhook server (make sure if it not already taken by other process) and can be changed using input parameter of `}<inlineCode parentName=\"p\">{`prometheus_webhook_snmptrapper`}</inlineCode>{`. `}</p>\n    <p>{`Edit Alertmanager secret in order to configure grouping and notification receiver.`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`oc -n openshift-monitoring get secret alertmanager-main --template='{{ index .data \"alertmanager.yaml\" }}' |base64 -d > alertmanager.yaml\n`}</code></pre>\n    <p>{`Then edit the `}<inlineCode parentName=\"p\">{`alertmanager.yaml`}</inlineCode>{`:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`global:\n  resolve_timeout: 5m\nroute:\n  group_wait: 30s\n  group_interval: 5m\n  repeat_interval: 12h\n  receiver: default\n  routes:\n  - match:\n      service: example-app\n    routes:\n    - match:\n        severity: critical\n      receiver: prometheus_webhook_snmptrapper\nreceivers:\n  - name: prometheus_webhook_snmptrapper\n    webhook_configs:\n    - url: 'http://<linux1_ip>:9999'\n`}</code></pre>\n    <p>{`With this configuration, alerts of critical severity fired by the `}<inlineCode parentName=\"p\">{`example-app`}</inlineCode>{` service are sent using the `}<inlineCode parentName=\"p\">{`prometheus_webhook_snmptrapper`}</inlineCode>{` receiver, which means that these alerts are paged to a chosen person.`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`$ oc -n openshift-monitoring create secret generic alertmanager-main --from-file=alertmanager.yaml --dry-run -o=yaml |  oc -n openshift-monitoring replace secret --filename=-\n`}</code></pre>\n    <p>{`4). Copy the following MIB files: `}<a parentName=\"p\" {...{\n        \"href\": \"https://raw.githubusercontent.com/chrusty/prometheus_webhook_snmptrapper/master/PROMETHEUS-TRAPPER-MIB.txt\"\n      }}>{`PROMETHEUS-TRAPPER-MIB.txt`}</a>{` and `}<a parentName=\"p\" {...{\n        \"href\": \"https://raw.githubusercontent.com/hardaker/net-snmp/master/mibs/SNMPv2-SMI.txt\"\n      }}>{`SNMPv2-SNI`}</a>{` to your MIB directory ex. `}<inlineCode parentName=\"p\">{`/usr/share/snmp/mibs`}</inlineCode>{`. You can find you MIBDIR using the following command:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`snmptranslate -Dinit_mib .1.3 2>&1 |grep MIBDIR\n`}</code></pre>\n    <p>{`5). Start `}<inlineCode parentName=\"p\">{`snmptrapd`}</inlineCode>{` using:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`snmptrapd -n -Ls d -m PROMETHEUS-TRAPPER-MIB\n`}</code></pre>\n    <p>{`It will start snmptrapd as a daemon and SNMP traps will be logged to local syslog file (`}<inlineCode parentName=\"p\">{`/var/log/syslog`}</inlineCode>{` by default on Ubuntu).`}</p>\n    <p>{`6). Start `}<inlineCode parentName=\"p\">{`prometheus_webhook_snmptrapper`}</inlineCode></p>\n    <pre><code parentName=\"pre\" {...{}}>{`./prometheus_webhook_snmptrapper --webhookaddress 0.0.0.0:9999 > prom_snmp.log 2>&1  &\n`}</code></pre>\n    <p>{`7). Verify that some Prometheus alerts has been generated after you started `}<inlineCode parentName=\"p\">{`prometheus_webhook_snmptrapper`}</inlineCode>{` and check the contents of syslog and `}<inlineCode parentName=\"p\">{`prom_snmp.log`}</inlineCode>{`.`}</p>\n    <p>{`The contents of `}<inlineCode parentName=\"p\">{`prom_snmp.log`}</inlineCode>{` should be similar to the one below:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`time=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Preparing the alerts channel\" logger=main\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Starting the SNMP trapper\" address=\"127.0.0.1:162\" logger=SNMP-trapper\ntime=\"2018-07-05T09:47:53-05:00\" level=info msg=\"Starting the Webhook server\" address=\"0.0.0.0:9999\" logger=Webhook-server\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Received a valid webhook alert\" logger=Webhook-server payload=\"{\\\\\"receiver\\\\\":\\\\\"default-receiver\\\\\",\\\\\"status\\\\\":\\\\\"firing\\\\\",\\\\\"alerts\\\\\":[{\\\\\"status\\\\\":\\\\\"firing\\\\\",\\\\\"labels\\\\\":{\\\\\"alertname\\\\\":\\\\\"ICPMonitoringHeartbeat\\\\\",\\\\\"severity\\\\\":\\\\\"none\\\\\"},\\\\\"annotations\\\\\":{\\\\\"description\\\\\":\\\\\"This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.\\\\\",\\\\\"summary\\\\\":\\\\\"Alerting Heartbeat\\\\\"},\\\\\"startsAt\\\\\":\\\\\"2018-06-26T11:49:29.035689542Z\\\\\",\\\\\"endsAt\\\\\":\\\\\"0001-01-01T00:00:00Z\\\\\",\\\\\"generatorURL\\\\\":\\\\\"http://monitoring-prometheus-77d664c568-jzqnp:9090/graph?g0.expr=vector%281%29\\\\\\\\u0026g0.tab=1\\\\\"}],\\\\\"groupLabels\\\\\":{\\\\\"alertname\\\\\":\\\\\"ICPMonitoringHeartbeat\\\\\"},\\\\\"commonLabels\\\\\":{\\\\\"alertname\\\\\":\\\\\"ICPMonitoringHeartbeat\\\\\",\\\\\"severity\\\\\":\\\\\"none\\\\\"},\\\\\"commonAnnotations\\\\\":{\\\\\"description\\\\\":\\\\\"This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.\\\\\",\\\\\"summary\\\\\":\\\\\"Alerting Heartbeat\\\\\"},\\\\\"externalURL\\\\\":\\\\\"http://monitoring-prometheus-alertmanager-7fdbf6c5cd-xdlhh:9093\\\\\",\\\\\"version\\\\\":\\\\\"4\\\\\",\\\\\"groupKey\\\\\":\\\\\"{}/{alertname=\\\\\\\\\\\\\"ICPMonitoringHeartbeat\\\\\\\\\\\\\"}:{alertname=\\\\\\\\\\\\\"ICPMonitoringHeartbeat\\\\\\\\\\\\\"}\\\\\"}\\\\n\"\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Forwarding an alert to the SNMP trapper\" index=0 labels=\"map[alertname:ICPMonitoringHeartbeat severity:none]\" logger=Webhook-server status=firing\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Received an alert\" logger=SNMP-trapper status=firing\ntime=\"2018-07-05T09:51:05-05:00\" level=debug msg=\"Created snmpgo.SNMP object\" address=\"127.0.0.1:162\" community=public logger=SNMP-trapper retries=1\ntime=\"2018-07-05T09:51:05-05:00\" level=info msg=\"It's a trap!\" logger=SNMP-trapper status=firing\n`}</code></pre>\n    <p>{`Example Prometheus SNMP traps logged to syslog:`}</p>\n    <pre><code parentName=\"pre\" {...{}}>{`Aug  6 07:55:20 csmo-icp2103-rs snmptrapd[7453]: 2018-08-06 07:55:20 UDP: [127.0.0.1]:55091->[127.0.0.1]:162 [UDP: [127.0.0.1]:55091->[127.0.0.1]:162]:#012SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperFiringNotification#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationTimestamp = STRING: 2018-08-06T12:14:09Z#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationDescription = STRING: 99th percentile Latency for LIST requests to the kube-apiserver is higher than 1s.#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationInstance = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationSeverity = STRING: warning#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationLocation = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationService = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationJob = STRING: kubernetes-apiservers\nAug  6 07:57:30 csmo-icp2103-rs snmptrapd[7453]: 2018-08-06 07:57:30 UDP: [127.0.0.1]:39868->[127.0.0.1]:162 [UDP: [127.0.0.1]:39868->[127.0.0.1]:162]:#012SNMPv2-SMI::snmpModules.1.1.4.1.0 = OID: PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperFiringNotification#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationTimestamp = STRING: 2018-08-06T12:00:29Z#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationDescription = STRING: This is a Hearbeat event meant to ensure that the entire Alerting pipeline is functional.#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationInstance = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationSeverity = STRING: none#011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationLocation = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationService = STRING: #011PROMETHEUS-TRAPPER-MIB-1::prometheusTrapperNotificationJob = STRING:\n`}</code></pre>\n\n    </MDXLayout>;\n}\n;\nMDXContent.isMDXComponent = true;\n      "],"sourceRoot":""}